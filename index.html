<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>index</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="Reactive Messaging Patterns with F# and Akka.NET"/>
    <meta name="author" content="Jorge Fioranelli"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="/fsharpreactivepatterns/content/style.css" />
    <script type="text/javascript" src="/fsharpreactivepatterns/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/jorgef/fsharpreactivepatterns">github page</a></li>
        </ul>
        <h3 class="muted"><a href="/fsharpreactivepatterns/index.html">Reactive Messaging Patterns with F# and Akka.NET</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<p><em>This article is part of the <a href="https://sergeytihon.wordpress.com/2015/10/25/f-advent-calendar-in-english-2015"  target="_blank">F# Advent Calendar in English 2015</a> organized by <a href="https://twitter.com/sergey_tihon" target="_blank">Sergey Tihon</a>.</em></p>

<p>I've been reading the book <a href="http://www.informit.com/store/reactive-messaging-patterns-with-the-actor-model-applications-9780133846836" target="_blank">Reactive Messaging Patterns with the Actor Model</a> by <a href="https://twitter.com/vaughnvernon" target="_blank">Vaughn Vernon</a> recently. This book applies the patterns described in <a href="http://www.enterpriseintegrationpatterns.com/" target="_blank">Enterprise Integration Patterns</a> using <a href="http://www.scala-lang.org" target="_blank">Scala</a> language and <a href="http://akka.io/" target="_blank">Akka</a> (Actor Model).</p>

<p>As I am an F# fan, I thought it would be good to translate the book examples to <a href="http://fsharp.org" target="_blank">F#</a> and <a href="http://getakka.net" target="_blank">Akka.NET</a>. If you already know F# and Akka.NET (or want to learn), you may find the examples I share here useful while reading the book. Additionally, if you are interested in the Scala examples described in the book, you can find them <a href="https://github.com/VaughnVernon/ReactiveMessagingPatterns_ActorModel" target="_blank">here</a>.</p>

<h2><a name="Sections" class="anchor" href="#Sections">Sections</a></h2>

<ol>
<li><strong>Introduction</strong></li>
<li><a href="messaging-with-actors.html">Messaging with Actors</a></li>
<li><a href="messaging-channels.html">Messaging Channels</a></li>
<li><a href="message-construction.html">Message Construction</a></li>
<li><a href="message-routing.html">Message Routing</a></li>
<li><a href="message-transformation.html">Message Transformation</a></li>
<li><a href="message-endpoints.html">Message Endpoints</a></li>
<li><a href="system-management-and-infrastructure.html">System Management and Infrastructure</a></li>
</ol>

<h2><a name="Introduction" class="anchor" href="#Introduction">Introduction</a></h2>

<p>Before we start, it is worth mentioning that the <a href="http://getakka.net/docs/FSharp API" target="_blank">Akka.NET F# API</a> provides different ways to create actors, the simplest one allows you to do it in just one line of code!</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">actorRef</span> <span class="o">=</span> <span class="i">spawn</span> <span class="i">system</span> <span class="s">&quot;myActor&quot;</span> (<span class="i">actorOf</span> (<span class="k">fun</span> <span class="i">msg</span> <span class="k">-&gt;</span> <span class="c">(* Handle message here *)</span> () ))
</code></pre></td>
</tr>
</table>

<p>Although this is very impressive, the truth is that sometimes you will need more control over the way the actor is created and how it interacts with Akka.NET. So, to keep the code examples consistent, I chose to use a more advanced technique, the <strong>actor</strong> <a href="https://msdn.microsoft.com/en-us/library/dd233182.aspx" target="_blank">computation expression</a>:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="f">myActor</span> (<span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="i">mailbox</span><span class="o">:</span> <span class="i">Actor</span><span class="o">&lt;</span>_<span class="o">&gt;</span>) <span class="o">=</span> 
    <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs4', 4)" onmouseover="showTip(event, 'fs4', 4)" class="f">loop</span> () <span class="o">=</span> <span class="i">actor</span> {
        <span class="k">let!</span> <span class="i">message</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs3', 5)" onmouseover="showTip(event, 'fs3', 5)" class="i">mailbox</span><span class="o">.</span><span class="i">Receive</span> ()
        <span class="c">// Handle message here</span>
        <span class="k">return!</span> <span onmouseout="hideTip(event, 'fs4', 6)" onmouseover="showTip(event, 'fs4', 6)" class="i">loop</span> ()
    }
    <span onmouseout="hideTip(event, 'fs4', 7)" onmouseover="showTip(event, 'fs4', 7)" class="f">loop</span> ()
</code></pre></td>
</tr>
</table>

<p>This second option is more verbose but it is also more powerful, as you have full access to the <strong>mailbox</strong> and you can control when the recursive function is executed.</p>

<p>As you can see, an actor is just a function that:</p>

<ul>
<li>Receives the mailbox as parameter</li>
<li>Returns an actor computation expression</li>
</ul>

<p>The mailbox is of type <strong>Actor<'a></strong>, where 'a is the type of message the actor will handle. In most cases you can leave the type as <strong>Actor<_></strong> and the F# compiler will infer the right message type for you.</p>

<p>The <strong>actor</strong> computation expression is returned using a self-invoking recursive function called <strong>loop</strong>. Its first line <strong>let! message = mailbox.Receive ()</strong> is receiving the message sent to the actor. If no message is available yet, the actor will be blocked until a message arrives. After the message is received and handled, the line <strong>return! Loop ()</strong>  is executed, which invokes the loop again to wait for the next message.</p>

<p>Finally, the last line <strong>loop ()</strong> executes the recursive function for the first time, starting the actor.</p>

<p>Don't worry if you couldn't follow the code easily, it took me a while to get my mind around it too. I recommend you to write a few actors to fully understand how it works.</p>

<p>Once you have defined an actor, you can create a new instance using the <strong>spawn</strong> function:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs1', 8)" onmouseover="showTip(event, 'fs1', 8)" class="i">actorRef</span> <span class="o">=</span> <span class="i">spawn</span> <span class="i">system</span> <span class="s">&quot;myActor&quot;</span> <span onmouseout="hideTip(event, 'fs2', 9)" onmouseover="showTip(event, 'fs2', 9)" class="i">myActor</span>
</code></pre></td>
</tr>
</table>

<p>Here we need to provide three things: the actor's system, a unique name ("myActor") and the actor function (myActor).</p>

<p>Now that you have created the actor, you can send it messages in this way:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs1', 10)" onmouseover="showTip(event, 'fs1', 10)" class="i">actorRef</span> <span class="o">&lt;!</span> <span class="s">&quot;message&quot;</span>
</code></pre></td>
</tr>
</table>

<h3><a name="How-to-Run-the-Examples" class="anchor" href="#How-to-Run-the-Examples">How to Run the Examples</a></h3>

<ol>
<li>Clone <em><a href="https://github.com/jorgef/fsharpreactivepatterns.git">https://github.com/jorgef/fsharpreactivepatterns.git</a></em> (more info: <a href="https://help.github.com/articles/cloning-a-repository" targe="_blank">cloning a repository</a>)</li>
<li>Open <em>FSharpReactivePatterns.sln</em> and build the solution (you need internet connection, it will download the dependencies)</li>
<li>Open the example (fsx file) you want to run</li>
<li>Select all the code except the part where messages are sent to the actor(s), and send it to F# Interactive</li>
<li>Clear the F# Interactive (optional)</li>
<li>Select the code that calls the actor(s) and send it to F# Interactive</li>
</ol>

<p><img src="http://jorgef.github.io/fsharpreactivepatterns/img/run.gif" alt="How to Run" /></p>

<h3><a name="What-s-Next" class="anchor" href="#What-s-Next">What's Next</a></h3>

<p>Great! Now that you know the basics you can start browsing and running the <a href="#Sections">patterns</a>, enjoy!</p>

<p>Let me know what you think: <a href="https://twitter.com/jorgefioranelli" target="_blank">@jorgefioranelli</a></p>

<h3><a name="Special-Thanks" class="anchor" href="#Special-Thanks">Special Thanks</a></h3>

<ul>
<li>To <a href="https://twitter.com/vaughnvernon" target="_blank">Vaughn Vernon</a> for writing the <a href="http://www.informit.com/store/reactive-messaging-patterns-with-the-actor-model-applications-9780133846836" target="_blank">book</a>.</li>
<li>To <a href="https://twitter.com/Horusiath" target="_blank">Bartosz Sypytkowski</a> for providing support about <a href="https://getakka.net" target="_blank">Akka.NET</a> and the <a href="https://getakka.net" target="_blank">F# API</a>.</li>
<li>To <a href="https://twitter.com/sforkmann" target="_blank">Steffen Forkmann</a> for helping me to setup the documentation.</li>
</ul>

<div class="tip" id="fs1">val actorRef : obj<br /><br />Full name: index.actorRef</div>
<div class="tip" id="fs2">val myActor : mailbox:&#39;a -&gt; &#39;b<br /><br />Full name: index.myActor</div>
<div class="tip" id="fs3">val mailbox : &#39;a</div>
<div class="tip" id="fs4">val loop : (unit -&gt; &#39;c)</div>

        </div>
        <div class="span3">
          <img src="/fsharpreactivepatterns/img/logo.png" alt="F# Project" style="width:150px;margin:10px" />  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">Reactive Messaging Patterns with F# and Akka.NET</li>
            <li><a href="/fsharpreactivepatterns/index.html">Home page</a></li>
            <li class="divider"></li>
            
            <li><a href="http://github.com/jorgef/fsharpreactivepatterns">Source Code on GitHub</a></li>
            <li><a href="/fsharpreactivepatterns/license.html">License</a></li>
            
            
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/jorgef/fsharpreactivepatterns"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
